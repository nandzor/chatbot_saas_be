<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Recent Messages API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .token-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Test Recent Messages API</h1>

    <div class="container">
        <h3>1. Set Authentication Token</h3>
        <input type="text" id="tokenInput" class="token-input" placeholder="Enter JWT token here...">
        <button onclick="setToken()">Set Token</button>
        <button onclick="clearToken()">Clear Token</button>
        <div id="tokenStatus"></div>
    </div>

    <div class="container">
        <h3>2. Test Recent Messages API</h3>
        <button onclick="testRecentMessages()">Test Recent Messages</button>
        <button onclick="testSearchMessages()">Test Search Messages</button>
        <div id="apiResult"></div>
    </div>

    <div class="container">
        <h3>3. Test with Different Session IDs</h3>
        <input type="text" id="sessionIdInput" class="token-input" placeholder="Enter session ID (default: a3253b82-ad04-4e98-9a5f-c5612250968b)" value="a3253b82-ad04-4e98-9a5f-c5612250968b">
        <button onclick="testWithCustomSession()">Test with Custom Session</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9000/api';
        const SESSION_ID = 'a3253b82-ad04-4e98-9a5f-c5612250968b';

        function setToken() {
            const token = document.getElementById('tokenInput').value;
            if (token) {
                localStorage.setItem('jwt_token', token);
                document.getElementById('tokenStatus').innerHTML = '<div class="success">‚úÖ Token set successfully!</div>';
            } else {
                document.getElementById('tokenStatus').innerHTML = '<div class="error">‚ùå Please enter a token</div>';
            }
        }

        function clearToken() {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('sanctum_token');
            document.getElementById('tokenStatus').innerHTML = '<div class="error">üóëÔ∏è Token cleared</div>';
        }

        async function makeApiCall(url, options = {}) {
            const token = localStorage.getItem('jwt_token');
            const sanctumToken = localStorage.getItem('sanctum_token');

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            if (sanctumToken) {
                headers['X-Sanctum-Token'] = sanctumToken;
            }

            console.log('üîç Making API call:', url);
            console.log('üîç Headers:', headers);

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                console.log('üîç Response status:', response.status);
                console.log('üîç Response headers:', Object.fromEntries(response.headers.entries()));

                const data = await response.json();

                if (response.ok) {
                    return { success: true, data, status: response.status };
                } else {
                    return { success: false, error: data, status: response.status };
                }
            } catch (error) {
                console.error('‚ùå API call failed:', error);
                return { success: false, error: error.message, status: 0 };
            }
        }

        async function testRecentMessages() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div>üîÑ Testing Recent Messages API...</div>';

            const sessionId = document.getElementById('sessionIdInput').value || SESSION_ID;
            const url = `${API_BASE_URL}/conversations/${sessionId}/recent?limit=10`;

            const result = await makeApiCall(url);

            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Recent Messages API Success!</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Messages Found:</strong> ${result.data.data.conversation.messages.length}</p>
                        <p><strong>Total Messages:</strong> ${result.data.data.total_messages}</p>
                        <details>
                            <summary>View Full Response</summary>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Recent Messages API Failed!</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Error:</strong> ${JSON.stringify(result.error, null, 2)}</p>
                    </div>
                `;
            }
        }

        async function testSearchMessages() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div>üîÑ Testing Search Messages API...</div>';

            const sessionId = document.getElementById('sessionIdInput').value || SESSION_ID;
            const url = `${API_BASE_URL}/conversations/${sessionId}/search?q=test&per_page=5`;

            const result = await makeApiCall(url);

            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Search Messages API Success!</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Messages Found:</strong> ${result.data.data.messages.length}</p>
                        <p><strong>Total Found:</strong> ${result.data.data.total_found}</p>
                        <details>
                            <summary>View Full Response</summary>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Search Messages API Failed!</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Error:</strong> ${JSON.stringify(result.error, null, 2)}</p>
                    </div>
                `;
            }
        }

        async function testWithCustomSession() {
            await testRecentMessages();
        }

        // Auto-load token if available
        window.onload = function() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                document.getElementById('tokenInput').value = token;
                document.getElementById('tokenStatus').innerHTML = '<div class="success">‚úÖ Token loaded from localStorage</div>';
            }
        };
    </script>
</body>
</html>
